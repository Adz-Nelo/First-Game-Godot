[gd_scene load_steps=10 format=3 uid="uid://bhsjyjh4n4ewt"]

[ext_resource type="Texture2D" uid="uid://wxbhpc2gkmyl" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Winter Fox/Sprites/fox-1.png" id="1_somxj"]
[ext_resource type="Texture2D" uid="uid://2132mp4tpq2o" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Winter Fox/Sprites/fox-2.png" id="2_pcpmy"]
[ext_resource type="Texture2D" uid="uid://crmt6rihi6s6l" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Winter Fox/Sprites/fox-3.png" id="3_slltw"]
[ext_resource type="Texture2D" uid="uid://ds2u2fscxs2e7" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Winter Fox/Sprites/fox-4.png" id="4_6i76r"]
[ext_resource type="Texture2D" uid="uid://dcmugv0kxj45l" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Winter Fox/Sprites/fox-5.png" id="5_yd78t"]
[ext_resource type="Texture2D" uid="uid://bdu1ow274nwc7" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Winter Fox/Sprites/fox-6.png" id="6_5u6l4"]

[sub_resource type="GDScript" id="GDScript_somxj"]
script/source = "extends CharacterBody2D
@onready var animated_sprite = $AnimatedSprite2D
@onready var ray_cast_right = $RayCastRight
@onready var ray_cast_left = $RayCastLeft

# Movement settings
@export var walk_speed = 50.0
@export var random_walk = false  # Set to true for random movement
@export var randomize_speed = true  # Randomize speed on spawn
@export var min_speed_multiplier = 0.6  # Slowest (60% of base speed)
@export var max_speed_multiplier = 1.5  # Fastest (150% of base speed)

var direction = 1  # 1 = right, -1 = left
var walk_timer = 0.0
var idle_timer = 0.0
var is_idle = false
var actual_speed = 50.0  # The actual speed this fox will use

func _ready() -> void:
	# Add to enemies group for easy identification
	add_to_group(\"enemies\")
	
	# Prevent culling when off-screen
	set_process_mode(Node.PROCESS_MODE_ALWAYS)
	
	# Randomize speed if enabled
	if randomize_speed:
		var speed_multiplier = randf_range(min_speed_multiplier, max_speed_multiplier)
		actual_speed = walk_speed * speed_multiplier
		print(\"ðŸ¦Š Fox spawned with speed:\", actual_speed, \"(\", int(speed_multiplier * 100), \"%)\")
	else:
		actual_speed = walk_speed
	
	# Start walking animation
	if animated_sprite:
		animated_sprite.play(\"Walk\")
		# Adjust animation speed based on movement speed
		animated_sprite.speed_scale = actual_speed / walk_speed
	
	# Randomize starting direction
	if randf() > 0.5:
		direction = -1
	
	update_sprite_direction()
	
	# Initialize timers
	if random_walk:
		walk_timer = randf_range(2.0, 5.0)

func _physics_process(delta: float) -> void:
	# Add gravity
	if not is_on_floor():
		velocity.y += get_gravity().y * delta
	
	if random_walk:
		random_walking(delta)
	else:
		patrol_walking()
	
	# Store old velocity to check if we hit something
	var old_velocity = velocity
	
	move_and_slide()
	
	# Check if we collided with something horizontally
	if is_on_wall():
		# Check what we hit
		for i in get_slide_collision_count():
			var collision = get_slide_collision(i)
			var collider = collision.get_collider()
			
			# If we hit another enemy or any obstacle, turn around
			if collider:
				if collider.is_in_group(\"enemies\") or collider is TileMap or collider is StaticBody2D:
					turn_around()
					break
	
	# Always sync sprite with movement direction
	update_sprite_direction()

func patrol_walking():
	# Simple back and forth patrol with randomized speed
	velocity.x = direction * actual_speed
	
	# Check if there's a wall ahead with raycasts
	var should_turn = false
	
	if direction == 1 and ray_cast_right and ray_cast_right.is_colliding():
		should_turn = true
	elif direction == -1 and ray_cast_left and ray_cast_left.is_colliding():
		should_turn = true
	
	# Turn around if needed
	if should_turn:
		turn_around()

func random_walking(delta: float):
	# Random walking with occasional stops
	if is_idle:
		velocity.x = 0
		idle_timer -= delta
		
		if idle_timer <= 0:
			is_idle = false
			walk_timer = randf_range(2.0, 5.0)
			
			# Random chance to change direction
			if randf() > 0.5:
				turn_around()
			
			if animated_sprite:
				animated_sprite.play(\"Walk\")
	else:
		velocity.x = direction * actual_speed
		walk_timer -= delta
		
		if walk_timer <= 0:
			is_idle = true
			idle_timer = randf_range(1.0, 3.0)
			
			if animated_sprite:
				animated_sprite.play(\"Idle\")
	
	# Still check for walls with raycasts
	if ray_cast_right and direction == 1 and ray_cast_right.is_colliding():
		turn_around()
	elif ray_cast_left and direction == -1 and ray_cast_left.is_colliding():
		turn_around()

func turn_around():
	direction *= -1
	update_sprite_direction()

func update_sprite_direction():
	if animated_sprite:
		# If your sprite FACES RIGHT by default
		animated_sprite.flip_h = (direction == -1)  # Flip when moving left
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_706rl"]
size = Vector2(40, 26)

[sub_resource type="SpriteFrames" id="SpriteFrames_8x0u3"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": ExtResource("1_somxj")
}, {
"duration": 1.0,
"texture": ExtResource("2_pcpmy")
}, {
"duration": 1.0,
"texture": ExtResource("3_slltw")
}, {
"duration": 1.0,
"texture": ExtResource("4_6i76r")
}, {
"duration": 1.0,
"texture": ExtResource("5_yd78t")
}, {
"duration": 1.0,
"texture": ExtResource("6_5u6l4")
}],
"loop": true,
"name": &"Walk",
"speed": 5.0
}]

[node name="Fox" type="CharacterBody2D"]
script = SubResource("GDScript_somxj")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(4, 3)
shape = SubResource("RectangleShape2D_706rl")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="."]
sprite_frames = SubResource("SpriteFrames_8x0u3")
animation = &"Walk"
