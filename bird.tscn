[gd_scene load_steps=10 format=3 uid="uid://djpe7kex3sduk"]

[ext_resource type="Texture2D" uid="uid://cohodpmks1rtu" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/flying-bird/Sprites/flying-creature-cycle-skin1.png" id="1_yr30m"]
[ext_resource type="Texture2D" uid="uid://ctvqewnf0yjsy" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/flying-bird/Sprites/flying-creature-cycle-skin2.png" id="2_2o5yp"]
[ext_resource type="Texture2D" uid="uid://dtlruf3puq5fl" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/flying-bird/Sprites/flying-creature-cycle-skin3.png" id="3_k3v35"]
[ext_resource type="Texture2D" uid="uid://35ncjx6vpc5e" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/flying-bird/Sprites/flying-creature-cycle-skin4.png" id="4_6nk3w"]
[ext_resource type="Texture2D" uid="uid://canfc1fhp0tby" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/flying-bird/Sprites/flying-creature-cycle-skin5.png" id="5_w265n"]
[ext_resource type="Texture2D" uid="uid://chq0xq3bs165h" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/flying-bird/Sprites/flying-creature-cycle-skin6.png" id="6_l2t0q"]
[ext_resource type="Texture2D" uid="uid://c6btjns2dhf2" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/flying-bird/Sprites/flying-creature-cycle-skin7.png" id="7_vab2h"]

[sub_resource type="GDScript" id="GDScript_yr30m"]
script/source = "extends CharacterBody2D
@onready var animated_sprite = $AnimatedSprite2D

# Speed relative to background
var background_scroll_speed = 100.0  # Match your background speed
var bird_relative_speed = 120.0  # How much faster than background
var actual_fly_speed = 0.0

# Speed randomization ranges
@export var min_bird_speed = 80.0
@export var max_bird_speed = 200.0

# Screen bounds
var spawn_x = -50.0
var despawn_x = 0.0

# Flight area (assigned per bird)
@export var min_flight_height = 60.0
@export var max_flight_height = 280.0

# Natural movement
var bob_amplitude = 15.0
var bob_speed = 3.0
var time = 0.0
var initial_y = 0.0  # Store the center Y position for this bird

# Variety
#var bird_colors = [
	#Color(1.0, 1.0, 1.0),     # White bird
	#Color(0.85, 0.7, 0.5),    # Brown bird
	#Color(0.6, 0.6, 0.6),     # Gray bird
#]

func _ready() -> void:
	animated_sprite.play(\"Flying\")
	
	# Prevent bird from being culled when off-screen
	set_process_mode(Node.PROCESS_MODE_ALWAYS)
	
	# Get screen width
	despawn_x = get_viewport_rect().size.x + 50
	
	# Random bird color
	#animated_sprite.modulate = bird_colors[randi() % bird_colors.size()]
	
	# Random size
	var scale_factor = randf_range(0.8, 1.2)
	animated_sprite.scale = Vector2(scale_factor, scale_factor)
	
	# Initialize with a random starting time so birds aren't synchronized
	time = randf_range(0, TAU)
	
	# If bird is placed in scene, use its position as the flight area center
	if position.x > spawn_x:
		initial_y = position.y
		min_flight_height = initial_y - 60
		max_flight_height = initial_y + 60
	
	reset_bird()

func _process(delta: float) -> void:
	# Move bird (background scrolls left at 100, bird flies right at ~220)
	position.x += actual_fly_speed * delta
	
	# Natural bobbing around the bird's assigned center height
	time += delta * bob_speed
	var bob_offset = sin(time) * bob_amplitude
	
	# Keep bird centered around its initial_y with bobbing
	var target_y = initial_y + bob_offset
	# Clamp to flight area
	target_y = clamp(target_y, min_flight_height, max_flight_height)
	position.y = lerp(position.y, target_y, 5.0 * delta)
	
	# Slight tilt based on bobbing (looks more natural)
	animated_sprite.rotation_degrees = bob_offset * 0.5
	
	# Get camera position if it exists
	var camera = get_viewport().get_camera_2d()
	if camera:
		var camera_x = camera.global_position.x
		var screen_width = get_viewport_rect().size.x
		
		# Update despawn based on camera position
		despawn_x = camera_x + screen_width + 50
		
		# Update spawn to be behind camera
		spawn_x = camera_x - 100
	
	# Respawn when off-screen (right side)
	if position.x > despawn_x:
		reset_bird()
	
	# Also respawn if bird gets too far behind camera (left side)
	if camera and position.x < camera.global_position.x - 200:
		reset_bird()

func reset_bird():
	# Respawn on left
	position.x = spawn_x
	
	# Pick a random height within the flight area for this bird
	initial_y = randf_range(min_flight_height, max_flight_height)
	position.y = initial_y
	
	# Calculate actual speed with MORE randomization
	bird_relative_speed = randf_range(min_bird_speed, max_bird_speed)
	actual_fly_speed = background_scroll_speed + bird_relative_speed
	
	# Randomize movement parameters for variety
	bob_speed = randf_range(2.0, 4.5)
	bob_amplitude = randf_range(8.0, 18.0)
	time = randf_range(0, TAU)  # Random starting phase so birds aren't in sync
	
	# Random size variation each respawn
	var scale_factor = randf_range(0.7, 1.3)
	animated_sprite.scale = Vector2(scale_factor, scale_factor)
	
	# Random color each spawn
	#animated_sprite.modulate = bird_colors[randi() % bird_colors.size()]

# Optional: Call this function to set a specific flight zone for this bird
func set_flight_zone(min_y: float, max_y: float):
	min_flight_height = min_y
	max_flight_height = max_y
	initial_y = (min_y + max_y) / 2.0
"

[sub_resource type="SpriteFrames" id="SpriteFrames_f430k"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": ExtResource("1_yr30m")
}, {
"duration": 1.0,
"texture": ExtResource("2_2o5yp")
}, {
"duration": 1.0,
"texture": ExtResource("3_k3v35")
}, {
"duration": 1.0,
"texture": ExtResource("4_6nk3w")
}, {
"duration": 1.0,
"texture": ExtResource("5_w265n")
}, {
"duration": 1.0,
"texture": ExtResource("6_l2t0q")
}, {
"duration": 1.0,
"texture": ExtResource("7_vab2h")
}],
"loop": true,
"name": &"Flying",
"speed": 5.0
}]

[node name="Bird" type="CharacterBody2D"]
script = SubResource("GDScript_yr30m")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="."]
position = Vector2(0, -3)
sprite_frames = SubResource("SpriteFrames_f430k")
animation = &"Flying"
autoplay = "Flying"
