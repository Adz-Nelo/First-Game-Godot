[gd_scene load_steps=16 format=3 uid="uid://d7smj0hg4h1e"]

[ext_resource type="Texture2D" uid="uid://b7ga0pxea3o0c" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Opossum/opossum/opossum-1.png" id="1_3xbym"]
[ext_resource type="Texture2D" uid="uid://dsa6siqhy4sxe" path="res://Sunny Land Collection Files/Assets/Props Items and VFX/Sunnyland FX/Sprites/enemy-death/enemy-death-1.png" id="1_ssx64"]
[ext_resource type="Texture2D" uid="uid://dla8rlmfwm0nf" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Opossum/opossum/opossum-2.png" id="2_i5bjm"]
[ext_resource type="Texture2D" uid="uid://bpqgvyv7ku6m6" path="res://Sunny Land Collection Files/Assets/Props Items and VFX/Sunnyland FX/Sprites/enemy-death/enemy-death-2.png" id="2_jgv2w"]
[ext_resource type="Texture2D" uid="uid://dqi0fnsksuj1g" path="res://Sunny Land Collection Files/Assets/Props Items and VFX/Sunnyland FX/Sprites/enemy-death/enemy-death-3.png" id="3_eocaq"]
[ext_resource type="Texture2D" uid="uid://7g1ibnfqfpcm" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Opossum/opossum/opossum-3.png" id="3_q1jwu"]
[ext_resource type="Texture2D" uid="uid://c7byl5vvjj20m" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Opossum/opossum/opossum-4.png" id="4_ft7pu"]
[ext_resource type="Texture2D" uid="uid://odgseuoliqpg" path="res://Sunny Land Collection Files/Assets/Props Items and VFX/Sunnyland FX/Sprites/enemy-death/enemy-death-4.png" id="4_lhowr"]
[ext_resource type="Texture2D" uid="uid://b2rvetpyxkcfa" path="res://Sunny Land Collection Files/Assets/Props Items and VFX/Sunnyland FX/Sprites/enemy-death/enemy-death-5.png" id="5_25dy3"]
[ext_resource type="Texture2D" uid="uid://d3nxh7nao4286" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Opossum/opossum/opossum-5.png" id="5_b5qag"]
[ext_resource type="Texture2D" uid="uid://bt5bwwsnb7hat" path="res://Sunny Land Collection Files/Assets/Characters/Enemies and NPC/Opossum/opossum/opossum-6.png" id="6_xgvlc"]
[ext_resource type="Texture2D" uid="uid://ckqitcv5688vs" path="res://Sunny Land Collection Files/Assets/Props Items and VFX/Sunnyland FX/Sprites/enemy-death/enemy-death-6.png" id="6_xxq4j"]

[sub_resource type="GDScript" id="GDScript_wjnk1"]
script/source = "extends CharacterBody2D
@onready var animated_sprite = $AnimatedSprite2D
@onready var ray_cast_right = $RayCastRight
@onready var ray_cast_left = $RayCastLeft

# Movement settings
@export var walk_speed = 50.0
@export var randomize_speed = true  # Randomize speed on spawn
@export var min_speed_multiplier = 0.6  # Slowest (60% of base speed)
@export var max_speed_multiplier = 1.5  # Fastest (150% of base speed)

var direction = 1  # 1 = right, -1 = left
var collision_cooldown = 0.0  # Prevents rapid direction changes
var actual_speed = 50.0  # The actual speed this opossum will use

# Screen bounds for looping
var spawn_x = -50.0
var despawn_x = 0.0
var ground_y = 0.0  # Store the ground level

func _ready() -> void:
	# Add to enemies group for easy identification
	add_to_group(\"enemies\")
	
	# Prevent culling when off-screen
	set_process_mode(Node.PROCESS_MODE_ALWAYS)
	
	# Get screen width
	despawn_x = get_viewport_rect().size.x + 50
	
	# Store initial ground position
	ground_y = global_position.y
	
	# Randomize speed if enabled
	if randomize_speed:
		var speed_multiplier = randf_range(min_speed_multiplier, max_speed_multiplier)
		actual_speed = walk_speed * speed_multiplier
		print(\"ðŸ¦ Opossum spawned with speed:\", actual_speed, \"(\", int(speed_multiplier * 100), \"%)\")
	else:
		actual_speed = walk_speed
	
	# Start walking animation
	if animated_sprite:
		animated_sprite.play(\"Walk\")
		# Adjust animation speed based on movement speed
		animated_sprite.speed_scale = actual_speed / walk_speed
	
	# Randomize starting direction
	if randf() > 0.5:
		direction = -1
	
	update_sprite_direction()

func _physics_process(delta: float) -> void:
	# Add gravity
	if not is_on_floor():
		velocity.y += get_gravity().y * delta
	else:
		# Update ground level when on floor
		ground_y = global_position.y
	
	# Decrease collision cooldown
	if collision_cooldown > 0:
		collision_cooldown -= delta
	
	# Always walk in current direction
	velocity.x = direction * actual_speed
	
	# Check if there's a wall ahead
	if direction == 1 and ray_cast_right and ray_cast_right.is_colliding():
		direction *= -1
	elif direction == -1 and ray_cast_left and ray_cast_left.is_colliding():
		direction *= -1
	
	move_and_slide()
	
	# Check for collisions with other enemies/mobs AFTER moving
	check_enemy_collisions()
	
	# Handle screen looping based on camera position
	handle_screen_loop()
	
	# Always sync sprite with movement direction
	update_sprite_direction()

func handle_screen_loop():
	# Get camera position if it exists
	var camera = get_viewport().get_camera_2d()
	if camera:
		var camera_x = camera.global_position.x
		var screen_width = get_viewport_rect().size.x
		
		# Update despawn based on camera position
		despawn_x = camera_x + screen_width + 50
		
		# Update spawn to be behind camera
		spawn_x = camera_x - 100
	
	# Respawn when off-screen (right side)
	if global_position.x > despawn_x:
		reset_opossum()
	
	# Also respawn if opossum gets too far behind camera (left side)
	if camera and global_position.x < camera.global_position.x - 200:
		reset_opossum()

func reset_opossum():
	# Respawn on left side at ground level
	global_position.x = spawn_x
	global_position.y = ground_y
	
	# Reset velocity
	velocity = Vector2.ZERO
	
	# Randomize speed again
	if randomize_speed:
		var speed_multiplier = randf_range(min_speed_multiplier, max_speed_multiplier)
		actual_speed = walk_speed * speed_multiplier
		
		# Update animation speed
		if animated_sprite:
			animated_sprite.speed_scale = actual_speed / walk_speed
	
	# Random direction
	direction = 1 if randf() > 0.5 else -1
	update_sprite_direction()

func update_sprite_direction():
	if animated_sprite:
		# If your sprite FACES LEFT by default
		animated_sprite.flip_h = (direction == 1)  # Flip when moving right

func check_enemy_collisions():
	# Only process if cooldown has expired
	if collision_cooldown > 0:
		return
	
	# Get number of collisions from last move_and_slide()
	for i in get_slide_collision_count():
		var collision = get_slide_collision(i)
		var body = collision.get_collider()
		
		# Check if it's another enemy/mob
		if body and body != self and body.is_in_group(\"enemies\"):
			# Calculate push direction away from other enemy
			var push_direction = sign(global_position.x - body.global_position.x)
			
			# If exactly on top of each other, pick random direction
			if push_direction == 0:
				push_direction = 1 if randf() > 0.5 else -1
			
			# Change direction
			direction = push_direction
			
			# Set cooldown to prevent immediate re-collision
			collision_cooldown = 0.5
			
			break
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_ssx64"]
size = Vector2(28, 16)

[sub_resource type="SpriteFrames" id="SpriteFrames_dy5wv"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": ExtResource("1_ssx64")
}, {
"duration": 1.0,
"texture": ExtResource("2_jgv2w")
}, {
"duration": 1.0,
"texture": ExtResource("3_eocaq")
}, {
"duration": 1.0,
"texture": ExtResource("4_lhowr")
}, {
"duration": 1.0,
"texture": ExtResource("5_25dy3")
}, {
"duration": 1.0,
"texture": ExtResource("6_xxq4j")
}],
"loop": true,
"name": &"Death",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("1_3xbym")
}, {
"duration": 1.0,
"texture": ExtResource("2_i5bjm")
}, {
"duration": 1.0,
"texture": ExtResource("3_q1jwu")
}, {
"duration": 1.0,
"texture": ExtResource("4_ft7pu")
}, {
"duration": 1.0,
"texture": ExtResource("5_b5qag")
}, {
"duration": 1.0,
"texture": ExtResource("6_xgvlc")
}],
"loop": true,
"name": &"Walk",
"speed": 5.0
}]

[node name="Opossum" type="CharacterBody2D"]
script = SubResource("GDScript_wjnk1")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(-3, -5)
shape = SubResource("RectangleShape2D_ssx64")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="."]
position = Vector2(1.0000002, -12.000001)
scale = Vector2(1.2142857, 1.2142857)
sprite_frames = SubResource("SpriteFrames_dy5wv")
animation = &"Walk"
